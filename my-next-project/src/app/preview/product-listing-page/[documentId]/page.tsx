import BlocksRender from "@/components/shared/BlocksRender";
import ShopByBrand from "@/components/plp/ShopByBrand";
import ShopByCategory from "@/components/plp/ShopByCategory";
import MainContent from "@/components/plp/main-content/index";
import strapiRequest from "@/utils/request";
import { cache } from "react";
import { Metadata } from "next";
import { map } from "lodash";

import "instantsearch.css/themes/satellite-min.css";

const getPLPLayout = cache(async (documentId: string) => {
  const response = await strapiRequest(
    `/api/product-listing-pages/${documentId}?populate[0]=mainContent&populate[1]=topPromotion.button&populate[2]=topPromotion.brands&populate[3]=topPromotion.brands.image&populate[4]=topPromotion.categories&populate[5]=bottomPromotion`
  );

  const layout = response.data.data;

  return layout;
});

type PageParams = { params: Promise<{ documentId: string }> };

export const metadata: Metadata = {
  title: "GC Strapi PLP Demo",
  description: "Generated by create next app",
};

async function ProductListingPage({ params }: PageParams) {
  const { documentId } = await params;

  const layout = await getPLPLayout(documentId);

  if (!layout) {
    return <div className="my-32">can not get layout from strapi.</div>;
  }

  return (
    <div>
      <div className="space-y-5 mx-auto max-w-[1500px] py-8">
        {map(layout.topPromotion, (section: any) => {
          switch (section.__component) {
            case "plp.shop-by-brand":
              return <ShopByBrand key={"plp.shop-by-brand" + section.id} data={section} />;

            case "plp.shop-by-category":
              return <ShopByCategory key={"plp.shop-by-category" + section.id} data={section} />;

            default:
              return null;
          }
        })}

        <MainContent data={layout.mainContent} />

        {map(layout.bottomPromotion, (section: any) => {
          switch (section.__component) {
            case "shared.html":
              return <BlocksRender key={"shared.html" + section.id} data={section} />;

            default:
              return null;
          }
        })}
      </div>
    </div>
  );
}

export default ProductListingPage;
